<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
<link rel="stylesheet" href="styles.css" />

<div id="input-container">
  <input type="file" id="files" name="files" />
  <label>Save slot: </label>
  <input type="number" id="slot" name="slot" min="1" value="3"/>
  <button class="btn btn-info" id="load">Load</button>
</div>
<h2 id="summary"></h2>
<output id="list"><div></div></output>

<script>
  const startAddress = 10360;
  const slotOffset = 8192;
  const androidOffset = 7877;
  const enemiesObject = [{ id: "1", name: "Dracula", img: "dracula.png", item1: "none", item2: "none" }, { id: "2", name: "Blood Skeleton", img: "blood-skeleton.png", item1: "none", item2: "none" }, { id: "3", name: "Bat", img: "bat.png", item1: "Potion", item2: "Monster Vial 2" }, { id: "4", name: "Stone Skull", img: "stone-skull.png", item1: "none", item2: "none" }, { id: "5", name: "Zombie", img: "zombie.png", item1: "$100", item2: "Cloth Tunic" }, { id: "6", name: "Merman", img: "merman2.png", item1: "Zircon", item2: "Monster Vial 1" }, { id: "7", name: "Skeleton", img: "skeleton.png", item1: "Shield Potion", item2: "Monster Vial 3" }, { id: "8", name: "Warg", img: "warg.png", item1: "none", item2: "none" }, { id: "9", name: "Bone Scimitar", img: "bone-scimitar.png", item1: "Short Sword", item2: "Red Rust" }, { id: "10", name: "Merman", img: "merman3.png", item1: "Zircon", item2: "Monster Vial 1" }, { id: "11", name: "Spittle Bone", img: "spittle-bone.png", item1: "none", item2: "none" }, { id: "12", name: "Axe Knight", img: "axe-knight4.png", item1: "Sub-weapon Axe", item2: "Bronze Cuirass" }, { id: "13", name: "Bloody Zombie", img: "bloody-zombie.png", item1: "Cloth Tunic", item2: "Basilard" }, { id: "14", name: "Slinger", img: "slinger.png", item1: "Leather Shield", item2: "Knight Shield" }, { id: "15", name: "Ouija Table", img: "ouija-table.png", item1: "Barley Tea", item2: "Morning Set" }, { id: "16", name: "Skelerang", img: "skelerang.png", item1: "Boomerang", item2: "Fire Boomerang" }, { id: "17", name: "Thornweed", img: "thornweed.png", item1: "Grapes", item2: "Strawberry" }, { id: "18", name: "Gaibon", img: "gaibon.png", item1: "none", item2: "none" }, { id: "19", name: "Ghost", img: "ghost.png", item1: "$400", item2: "Antivenom" }, { id: "20", name: "Marionette", img: "marionette.png", item1: "Smart Potion", item2: "Circlet" }, { id: "21", name: "Slogra", img: "slogra.png", item1: "none", item2: "none" }, { id: "22", name: "Diplocephalus", img: "diplocephalus.png", item1: "Pentagram", item2: "Tart" }, { id: "23", name: "Flea Man", img: "flea-man.png", item1: "Takemitsu", item2: "Cheese" }, { id: "24", name: "Medusa Head", img: "medusa-head7.png", item1: "Resist Stone", item2: "Medusa Shield" }, { id: "25", name: "Blade Soldier", img: "blade-soldier.png", item1: "$400", item2: "Nakamura" }, { id: "26", name: "Bone Musket", img: "bone-musket.png", item1: "Magic Missile", item2: "Talisman" }, { id: "27", name: "Medusa Head", img: "medusa-head8.png", item1: "Resist Stone", item2: "Medusa Shield" }, { id: "28", name: "Plate Lord", img: "plate-lord.png", item1: "Iron Ball", item2: "Neutron Bomb" }, { id: "29", name: "Stone Rose", img: "stone-rose.png", item1: "Leather Shield", item2: "Meal Ticket" }, { id: "30", name: "Axe Knight", img: "axe-knight9.png", item1: "Sub-weapon Axe", item2: "Axelord Shield" }, { id: "31", name: "Ctulhu", img: "ctulhu.png", item1: "Pentagram", item2: "Bat Pentagram" }, { id: "32", name: "Bone Archer", img: "bone-archer.png", item1: "$400", item2: "Magic Missile" }, { id: "33", name: "Bone Pillar", img: "bone-pillar.png", item1: "Antivenom", item2: "Ballroom Mask" }, { id: "34", name: "Doppleganger10", img: "doppleganger10.png", item1: "none", item2: "none" }, { id: "35", name: "Owl", img: "owl.png", item1: "none", item2: "none" }, { id: "36", name: "Phantom Skull", img: "phantom-skull.png", item1: "Felt Cap", item2: "Resist Dark" }, { id: "37", name: "Scylla wyrm", img: "scylla-wyrm.png", item1: "none", item2: "Nakamura" }, { id: "38", name: "Skeleton Ape", img: "skeleton-ape.png", item1: "Banana", item2: "TNT" }, { id: "39", name: "Spear Guard", img: "spear-guard.png", item1: "Javelin", item2: "Iron Cuirass" }, { id: "40", name: "Spellbook", img: "spellbook.png", item1: "$1000", item2: "Pentagram" }, { id: "41", name: "Winged Guard", img: "winged-guard.png", item1: "Iron Shield", item2: "Javelin" }, { id: "42", name: "Ectoplasm", img: "ectoplasm.png", item1: "Uncurse", item2: "Manna Prism" }, { id: "43", name: "Sword Lord", img: "sword-lord.png", item1: "Cutlass", item2: "Bekatowa" }, { id: "44", name: "Toad", img: "toad.png", item1: "Blue Knuckles", item2: "Pizza" }, { id: "45", name: "Armor Lord", img: "armor-lord.png", item1: "Rapier", item2: "Saber" }, { id: "46", name: "Corner Guard", img: "corner-guard.png", item1: "Cutlass", item2: "Damascus Sword" }, { id: "47", name: "Dhuron", img: "dhuron.png", item1: "Hide Cuirass", item2: "Rapier" }, { id: "48", name: "Frog", img: "frog.png", item1: "Knuckle Duster", item2: "Pizza" }, { id: "49", name: "Frozen Shade", img: "frozen-shade.png", item1: "Ice Mail", item2: "Icecream" }, { id: "50", name: "Magic Tome", img: "magic-tome.png", item1: "$2000", item2: "Saber" }, { id: "51", name: "Skull Lord", img: "skull-lord.png", item1: "Scimitar", item2: "Skull Shield" }, { id: "52", name: "Black Crow", img: "black-crow.png", item1: "Aquamarine", item2: "Red Bean Bun" }, { id: "53", name: "Blue Raven", img: "blue-raven.png", item1: "Zircon", item2: "Pork Bun" }, { id: "54", name: "Corpseweed", img: "corpseweed.png", item1: "Antivenom", item2: "Potion" }, { id: "55", name: "Flail Guard", img: "flail-guard.png", item1: "Morningstar", item2: "Pot Roast" }, { id: "56", name: "Flea Rider", img: "flea-rider.png", item1: "Turkey", item2: "Ham and Eggs" }, { id: "57", name: "Spectral Sword", img: "spectral-sword13.png", item1: "Broadsword", item2: "Bastard Sword" }, { id: "58", name: "Bone Halberd", img: "bone-halberd.png", item1: "Javelin", item2: "Ham and Eggs" }, { id: "59", name: "Scylla", img: "scylla.png", item1: "none", item2: "none" }, { id: "60", name: "Hunting Girl", img: "hunting-girl.png", item1: "Were Bane", item2: "Cheesecake" }, { id: "61", name: "Mudman", img: "mudman.png", item1: "none", item2: "none" }, { id: "62", name: "Owl Knight", img: "owl-knight.png", item1: "Cutlass", item2: "Medal" }, { id: "63", name: "Spectral Sword", img: "spectral-sword15.png", item1: "Broadsword", item2: "Bastard Sword" }, { id: "64", name: "Vandal Sword", img: "vandal-sword.png", item1: "Holy Sword", item2: "Muramasa" }, { id: "65", name: "Flea Armor", img: "flea-armor.png", item1: "High Potion", item2: "Iron Cuirass" }, { id: "66", name: "Hippogryph", img: "hippogryph.png", item1: "none", item2: "none" }, { id: "67", name: "Paranthropus", img: "paranthropus.png", item1: "Gauntlet", item2: "Ring of Varda" }, { id: "68", name: "Slime", img: "slime.png", item1: "none", item2: "none" }, { id: "69", name: "Blade Master", img: "blade-master.png", item1: "Shotel", item2: "Cross Shuriken" }, { id: "70", name: "Wereskeleton", img: "wereskeleton.png", item1: "Str. Potion", item2: "Garnet" }, { id: "71", name: "Grave Keeper", img: "grave-keeper.png", item1: "Miso Soup", item2: "Natou" }, { id: "72", name: "Gremlin", img: "gremlin.png", item1: "Resist Fire", item2: "Fire Mail" }, { id: "73", name: "Harpy", img: "harpy.png", item1: "Apple", item2: "Life Apple" }, { id: "74", name: "Minotaurus", img: "minotaurus.png", item1: "none", item2: "none" }, { id: "75", name: "Werewolf", img: "werewolf18.png", item1: "none", item2: "none" }, { id: "76", name: "Bone Ark", img: "bone-ark.png", item1: "Monster Vial 3", item2: "Skull Shield" }, { id: "77", name: "Valhalla Knight", img: "valhalla-knight.png", item1: "Estoc", item2: "Claymore" }, { id: "78", name: "Cloaked Knight", img: "cloaked-knight.png", item1: "Flamberge", item2: "Heaven Sword" }, { id: "79", name: "Fishhead", img: "fishhead.png", item1: "Resist Ice", item2: "Icebrand" }, { id: "80", name: "Lesser Demon", img: "lesser-demon.png", item1: "Obsidian Sword", item2: "Holbein Dagger" }, { id: "81", name: "Lossoth", img: "lossoth.png", item1: "Sirloin", item2: "Firebrand" }, { id: "82", name: "Salem Witch", img: "salem-witch.png", item1: "Gold Circlet", item2: "Shortcake" }, { id: "83", name: "Blade", img: "blade.png", item1: "Hunter Sword", item2: "Gold Plate" }, { id: "84", name: "Gurkha", img: "gurkha.png", item1: "Combat Knife", item2: "Gold Plate" }, { id: "85", name: "Hammer", img: "hammer.png", item1: "Hammer", item2: "Gold Plate" }, { id: "86", name: "Discus Lord", img: "discus-lord.png", item1: "Chakram", item2: "Jewel Sword" }, { id: "87", name: "Karasuman", img: "karasuman.png", item1: "Resist Dark", item2: "Ring of Feanor" }, { id: "88", name: "Large Slime", img: "large-slime.png", item1: "none", item2: "none" }, { id: "89", name: "Hellfire Beast", img: "hellfire-beast.png", item1: "Lightning Mail", item2: "Fire Mail" }, { id: "90", name: "Cerberos", img: "cerberos.png", item1: "none", item2: "none" }, { id: "91", name: "Killer Fish", img: "killer-fish.png", item1: "Aquamarine", item2: "Sushi" }, { id: "92", name: "Olrox", img: "olrox.png", item1: "none", item2: "none" }, { id: "93", name: "Succubus", img: "succubus.png", item1: "none", item2: "none" }, { id: "94", name: "Tombstone", img: "tombstone.png", item1: "Katana", item2: "Green Tea" }, { id: "95", name: "Venus Weed", img: "venus-weed.png", item1: "Coral Circlet", item2: "Heart Refresh" }, { id: "96", name: "Lion", img: "lion.png", item1: "Gauntlet", item2: "Fist of Tulkas" }, { id: "97", name: "Scarecrow", img: "scarecrow.png", item1: "Javelin", item2: "Muramasa" }, { id: "98", name: "Granfaloon", img: "granfaloon.png", item1: "none", item2: "none" }, { id: "99", name: "Schmoo", img: "schmoo.png", item1: "Ramen", item2: "Crissaegrim" }, { id: "100", name: "Tin man", img: "tin-man.png", item1: "Lunch A", item2: "Mojo Mail" }, { id: "101", name: "Balloon pod", img: "balloon-pod.png", item1: "none", item2: "none" }, { id: "102", name: "Yorick", img: "yorick.png", item1: "Monster Vial 3", item2: "Skull Shield" }, { id: "103", name: "Bomb Knight", img: "bomb-knight.png", item1: "TNT", item2: "Dynamite" }, { id: "104", name: "Flying Zombie", img: "flying-zombie.png", item1: "Shuriken", item2: "Frankfurter" }, { id: "105", name: "Bitterfly", img: "bitterfly.png", item1: "Luck Potion", item2: "Mystic Pendant" }, { id: "106", name: "Jack O' Bones", img: "jack-o'bones.png", item1: "Shuriken", item2: "Flame Star" }, { id: "107", name: "Archer", img: "archer.png", item1: "Heart Refresh", item2: "Vorpal Blade" }, { id: "108", name: "Werewolf", img: "werewolf34.png", item1: "Iron Fist", item2: "Yasutsuna" }, { id: "109", name: "Black Panther", img: "black-panther.png", item1: "Meal Ticket", item2: "Masamune" }, { id: "110", name: "Darkwing Bat", img: "darkwing-bat.png", item1: "none", item2: "none" }, { id: "111", name: "Dragon Rider", img: "dragon-rider.png", item1: "none", item2: "none" }, { id: "112", name: "Minotaur", img: "minotaur.png", item1: "Sirloin", item2: "Fury Plate" }, { id: "113", name: "Nova Skeleton", img: "nova-skeleton.png", item1: "Monster Vial 3", item2: "Terminus Est" }, { id: "114", name: "Orobourous", img: "orobourous.png", item1: "Karma Coin", item2: "Lapis Lazuli" }, { id: "115", name: "White Dragon", img: "white-dragon.png", item1: "none", item2: "none" }, { id: "116", name: "Fire Warg", img: "fire-warg.png", item1: "Turqoise", item2: "Karma Coin" }, { id: "117", name: "Rock Knight", img: "rock-knight.png", item1: "Jewel Knuckles", item2: "Platinum Mail" }, { id: "118", name: "Sniper of Goth", img: "sniper-of-goth.png", item1: "Magic Missile", item2: "Brilliant Mail" }, { id: "119", name: "Spectral Sword", img: "spectral-sword36.png", item1: "Gurthang", item2: "Mablung Sword" }, { id: "120", name: "Ghost Dancer", img: "ghost-dancer.png", item1: "Buffalo Star", item2: "Stone Mask" }, { id: "121", name: "Warg Rider", img: "warg-rider.png", item1: "none", item2: "none" }, { id: "122", name: "Cave Troll", img: "cave-troll.png", item1: "Neutron Bomb", item2: "Nauglamir" }, { id: "123", name: "Dark Octopus", img: "dark-octopus.png", item1: "Sushi", item2: "Green Tea" }, { id: "124", name: "Fire Demon", img: "fire-demon.png", item1: "Fire Shield", item2: "Marsil" }, { id: "125", name: "Gorgon", img: "gorgon.png", item1: "Hammer", item2: "Stone Sword" }, { id: "126", name: "Malachi", img: "malachi.png", item1: "Dark Shield", item2: "Dark Armor" }, { id: "127", name: "Akmodan II", img: "akmodan-ii.png", item1: "none", item2: "none" }, { id: "128", name: "Blue Venus Weed", img: "blue-venus-weed.png", item1: "Zweihander", item2: "Heart Refresh" }, { id: "129", name: "Doppleganger40", img: "doppleganger40.png", item1: "none", item2: "none" }, { id: "130", name: "Medusa", img: "medusa.png", item1: "none", item2: "none" }, { id: "131", name: "The Creature", img: "the-creature.png", item1: "none", item2: "none" }, { id: "132", name: "Fake Grant", img: "fake-grant.png", item1: "none", item2: "none" }, { id: "133", name: "Fake Trevor", img: "fake-trevor.png", item1: "none", item2: "none" }, { id: "134", name: "Imp", img: "imp.png", item1: "Luck Potion", item2: "King's Stone" }, { id: "135", name: "Fake Sypha", img: "fake-sypha.png", item1: "none", item2: "none" }, { id: "136", name: "Beezelbub", img: "beezelbub.png", item1: "none", item2: "none" }, { id: "137", name: "Azaghal", img: "azaghal.png", item1: "Covenant Stone", item2: "Mourneblade" }, { id: "138", name: "Frozen Half", img: "frozen-half.png", item1: "Necklace of J", item2: "Opal Circlet" }, { id: "139", name: "Salome", img: "salome.png", item1: "Wizard Hat", item2: "Manna Prism" }, { id: "140", name: "Richter Belmont", img: "richter-belmont.png", item1: "none", item2: "none" }, { id: "141", name: "Dodo Bird", img: "dodo-bird.png", item1: "Heart Broach", item2: "Runesword" }, { id: "142", name: "Galamoth", img: "galamoth.png", item1: "none", item2: "none" }, { id: "143", name: "Guardian", img: "guardian.png", item1: "Great Sword", item2: "God's Garb" }, { id: "144", name: "Death", img: "death.png", item1: "none", item2: "none" }, { id: "145", name: "Shaft", img: "shaft.png", item1: "none", item2: "none" }];
  const nonDroppersIndex = [0, 1, 3, 7, 10, 17, 20, 33, 34, 36, 58, 60, 65, 67, 73, 74, 87, 89, 91, 92, 97, 100, 109, 110, 114, 120, 126, 128, 129, 130, 131, 132, 134, 135, 139, 141, 143, 144];

  const getMissing = (binary) => {
    const bits = [];
    for (let i = 0; i < binary.length; i++) {
      if (binary[i] === '0') {
        bits.push(i);
      }
    }
    return bits;
  }

  const getBinArray = (input, start, reverse) => {
    let binary = input[start].charCodeAt(0).toString(2);
    const length = binary.length;
    if (length < 8) {
      for (let i= 0; i < (8 - length); i++) {
        binary = '0' + binary;
      }
    }
    return reverse ? binary.split("").reverse() : binary.split("");
  }

  const renderEnemyCard = (enemiesObject, updatedIndex) => {
    const card = document.createElement('li');
    const monster = document.createElement('div');
    const monsterId = document.createElement('span');
    const monsterImage = document.createElement('img');
    const monsterName = document.createElement('span');
    const itemsContainer = document.createElement('div');
    const item1 = document.createElement('span');
    const item2 = document.createElement('span');

    monster.className = 'monster';
    monsterId.className = 'monster-id';
    monsterImage.src = 'enemies/'+enemiesObject[updatedIndex].img;
    monsterName.innerHTML = enemiesObject[updatedIndex].name;
    monsterId.innerHTML = 'No.' + enemiesObject[updatedIndex].id;
    monster.appendChild(monsterId);
    monster.appendChild(monsterImage);
    monster.appendChild(monsterName);

    itemsContainer.className = 'items-container';
    item1.innerHTML = enemiesObject[updatedIndex].item1;
    item2.innerHTML = enemiesObject[updatedIndex].item2;
    itemsContainer.appendChild(item1);
    itemsContainer.appendChild(item2);

    card.appendChild(monster);
    card.appendChild(itemsContainer);

    return card;
  }

  const getEnemies = (input, startAddress) => {
    const enemies = [];
    const enemiesContainer = document.createElement('ul');
    // There 18 bytes of memory storing rare items dropped
    for (let enemyBlock = 0; enemyBlock < 18; enemyBlock ++ ) {
      binData = getBinArray(input, startAddress + enemyBlock, true);
      missingEnemies = getMissing(binData);
      missingEnemies.forEach((item) => {
        const updatedIndex = item + (enemyBlock * 8);
        // Check if current monster doesn't drop items at all
        const enemyIsDropper = (nonDroppersIndex.findIndex(item => item === updatedIndex) === -1) ;
        if (enemyIsDropper) {
          const card = renderEnemyCard(enemiesObject, updatedIndex);
          enemiesContainer.appendChild(card);

          enemies.push({
            id: (updatedIndex + 1),
            name: enemiesObject[updatedIndex].name,
            img: enemiesObject[updatedIndex].img,
          });
        }
      });
    }

    const summary = document.getElementById('summary');
    summary.innerText = 'Missing ' + enemies.length + ' rare items.';
    console.log(enemies);

    return enemiesContainer;
  }


  const loadMemoryCard = () => {
    const selectedSlot = document.getElementById('slot').value;
    const rareItemsAddress = startAddress + ((selectedSlot - 1) * slotOffset);
    const file = document.getElementById('files').files[0];
    if (!file) {
      alert('File not found!');
      return;
    }
    const fileNameArray = file.name.split(".");
    file.extension = fileNameArray[fileNameArray.length - 1];
    const reader = new FileReader();

    // Closure to capture the file information.
    reader.onload = (() => (e) => {
      const mcard = e.target.result;
      const list = document.getElementById('list');
      const startAddress = file.extension === 'sav' ? rareItemsAddress - androidOffset : rareItemsAddress;
      console.log(file.extension, startAddress);
      // Render result.
      list.removeChild(list.firstChild);
      list.appendChild(getEnemies(mcard, startAddress));
    })(file);

    reader.readAsBinaryString(file);

  }

  document.getElementById('load').addEventListener('click', loadMemoryCard, false);
</script>
